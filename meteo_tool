from langchain.agents import AgentExecutor, create_react_agent
from langchain.tools import Tool
from langchain.prompts import PromptTemplate
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
import requests
import json
from typing import Dict, Any, Optional
import os

class LocationCoordinateTool:
    """Tool to get coordinates from location names using Nominatim API"""
    
    def __init__(self, api_key: Optional[str] = None):
        self.api_key = api_key
        self.base_url = "https://nominatim.openstreetmap.org/search"
        self.headers = {
            'User-Agent': 'LocationCoordinateAgent/1.0',
            'Accept': 'application/json'
        }
    
    def get_coordinates(self, location: str) -> Dict[str, Any]:
        """
        Get coordinates for a given location
        Returns: {'latitude': float, 'longitude': float, 'display_name': str}
        """
        try:
            params = {
                'q': location,
                'format': 'json',
                'addressdetails': 1,
                'limit': 1
            }
            
            response = requests.get(
                self.base_url, 
                params=params, 
                headers=self.headers,
                timeout=10
            )
            
            if response.status_code == 200:
                data = response.json()
                if data:
                    place = data[0]
                    return {
                        'latitude': float(place['lat']),
                        'longitude': float(place['lon']),
                        'display_name': place.get('display_name', location),
                        'place_id': place.get('place_id')
                    }
                else:
                    return {
                        'error': 'Location not found',
                        'location': location
                    }
            else:
                return {
                    'error': f'API request failed with status {response.status_code}',
                    'location': location
                }
                
        except Exception as e:
            return {
                'error': f'Error processing location: {str(e)}',
                'location': location
            }

class LocationAgent:
    """LangChain agent that uses location coordinate tool"""
    
    def __init__(self, model_name: str = "gpt-3.5-turbo", temperature: float = 0.0):
        # Initialize the language model
        self.llm = ChatOpenAI(
            model=model_name,
            temperature=temperature,
            openai_api_key=os.getenv('OPENAI_API_KEY')
        )
        
        # Initialize the coordinate tool
        self.coordinate_tool = LocationCoordinateTool()
        
        # Create the tool
        self.tools = [
            Tool(
                name="GetCoordinates",
                func=self.coordinate_tool.get_coordinates,
                description="Useful for getting latitude and longitude coordinates from location names. Input should be a location name (e.g. 'Paris, France' or 'Eiffel Tower')."
            )
        ]
        
        # Create the prompt template
        self.prompt = ChatPromptTemplate.from_messages([
            ("system", "You are a helpful assistant that helps users find coordinates of locations. Always use the GetCoordinates tool when asked for location coordinates."),
            ("placeholder", "{chat_history}"),
            ("human", "{input}"),
            ("placeholder", "{agent_scratchpad}"),
        ])
        
        # Create the agent
        self.agent = create_react_agent(
            llm=self.llm,
            tools=self.tools,
            prompt=self.prompt
        )
        
        # Create the executor
        self.executor = AgentExecutor(
            agent=self.agent,
            tools=self.tools,
            verbose=True,
            handle_parsing_errors=True
        )
    
    def run(self, query: str) -> Dict[str, Any]:
        """
        Run the agent with a query
        """
        try:
            result = self.executor.invoke({"input": query})
            return {
                "success": True,
                "response": result["output"],
                "input": query
            }
        except Exception as e:
            return {
                "success": False,
                "error": str(e),
                "input": query
            }

# Example usage
if __name__ == "__main__":
    # Initialize the agent
    agent = LocationAgent()
    
    # Test queries
    test_queries = [
        "What are the coordinates of New York City?",
        "Find the location of the Eiffel Tower",
        "Get coordinates for Tokyo Japan",
        "Where is the Statue of Liberty located?"
    ]
    
    for query in test_queries:
        print(f"\nQuery: {query}")
        result = agent.run(query)
        if result["success"]:
            print(f"Response: {result['response']}")
        else:
            print(f"Error: {result['error']}")

# Alternative: Simple function-based approach
def get_location_coordinates(location: str) -> Dict[str, Any]:
    """
    Simple function to get coordinates for a location
    """
    tool = LocationCoordinateTool()
    return tool.get_coordinates(location)

# Example usage of simple function
coordinates = get_location_coordinates("London, UK")
print(coordinates)
